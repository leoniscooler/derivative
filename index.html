<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Derivative Solver & Grapher</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.12.0/math.js"></script>
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
    html, body {
        height: 100%;
        margin: 0;
        font-family: 'Helvetica Neue', Arial, sans-serif;
        background-color: #f5f5f5;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-direction: column;
        padding: 20px;
        text-align: center;
    }

    .calculator {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0px 10px 30px rgba(0,0,0,0.1);
        width: 600px;
        margin: auto;
    }

    input {
        width: 90%;
        font-size: 20px;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 10px;
        margin-bottom: 20px;
        outline: none;
        box-sizing: border-box;
    }

    input:focus {
        border-color: #4285f4;
        box-shadow: 0 0 5px rgba(66,133,244,0.5);
    }

    button {
        font-size: 18px;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background-color: #4285f4;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
        margin: 5px;
    }

    button:hover {
        background-color: #357ae8;
    }

    #result {
        font-size: 22px;
        margin-top: 20px;
        min-height: 40px;
        color: #222;
        word-wrap: break-word;
    }

    #graph {
        width: 100%;
        height: 500px;
        margin-top: 30px;
    }
</style>
</head>
<body>
<div class="calculator">
    <h1>Derivative Solver & Grapher</h1>
    <input type="text" id="funcInput" placeholder="Type a function, e.g., x^3 + 2*x, sin(x^2), ln(x)">
    <br>
    <button onclick="computeDerivative()">Derivative</button>
    <button onclick="nextDerivative()">Next Derivative</button>
    <div id="result"></div>
</div>

<div id="graph"></div>

<script>
let originalNode = null;
let derivativeNodes = []; // stores original + derivatives
let derivativeCount = 0;

function mathToTex(node) {
    return node.toTex({parenthesis: 'keep', implicit: 'show'});
}

function preprocessInput(input) {
    input = input.replace(/ln\(/g, 'log(');
    input = input.replace(/e\^/g, 'exp');
    return input;
}

function derivativeLabel(count) {
    if (count === 0) return "f(x)";
    else if (count === 1) return "f'(x)";
    else if (count === 2) return "f''(x)";
    else if (count === 3) return "f'''(x)";
    else return `f^{(${count})}(x)`;
}

function computeDerivative() {
    let input = document.getElementById('funcInput').value;
    input = preprocessInput(input);

    try {
        originalNode = math.parse(input);
        derivativeNodes = [originalNode];
        derivativeCount = 1;
        // compute first derivative
        let firstDerivative = math.derivative(originalNode, 'x');
        derivativeNodes.push(firstDerivative);
        displayAllDerivatives();
    } catch (err) {
        document.getElementById('result').innerText = 'Error: ' + err.message;
    }
}

function nextDerivative() {
    if (derivativeNodes.length === 0) {
        document.getElementById('result').innerText = 'Error: Compute a derivative first.';
        return;
    }
    try {
        let lastDerivative = derivativeNodes[derivativeNodes.length - 1];
        let nextDeriv = math.derivative(lastDerivative, 'x');
        derivativeNodes.push(nextDeriv);
        derivativeCount++;
        displayAllDerivatives();
    } catch (err) {
        document.getElementById('result').innerText = 'Error: ' + err.message;
    }
}

function displayAllDerivatives() {
    // Show all derivatives in MathJax
    let latexStr = '';
    for (let i = 1; i < derivativeNodes.length; i++) {
        let label = derivativeLabel(i);
        let latex = mathToTex(derivativeNodes[i]);
        latexStr += `$$${label} = ${latex}$$<br>`;
    }
    document.getElementById('result').innerHTML = latexStr;
    MathJax.typesetPromise();

    // Graph original + all derivatives
    let colors = ['#4285f4','#ea4335','#fbbc05','#34a853','#9c27b0','#ff5722','#009688'];
    let traces = [];
    for (let i = 0; i < derivativeNodes.length; i++) {
        let xValues = [];
        let yValues = [];
        for (let x = -10; x <= 10; x += 0.1) {
            xValues.push(x);
            try { yValues.push(derivativeNodes[i].evaluate({x:x})); }
            catch { yValues.push(NaN); }
        }
        traces.push({
            x: xValues,
            y: yValues,
            mode: 'lines',
            name: derivativeLabel(i),
            line: {color: colors[i % colors.length], dash: i===0 ? 'solid':'dash'}
        });
    }

    Plotly.newPlot('graph', traces, {title:'Function & Derivatives', xaxis:{title:'x'}, yaxis:{title:'y'}}, {responsive:true});
}
</script>
</body>
</html>
